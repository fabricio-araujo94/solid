<div class="container">
  <div class="control-panel">

    <!-- CARD: UPLOAD -->
    <div class="card">
      <h3>Upload de Imagens</h3>

      <form [formGroup]="uploadForm">
        <div class="form-group">
          <label for="imageFront">Imagem Frontal</label>
          <input type="file" id="imageFront" (change)="onFileSelected($event, 'imageFront')">
        </div>

        <div class="form-group">
          <label for="imageSide">Imagem Lateral</label>
          <input type="file" id="imageSide" (change)="onFileSelected($event, 'imageSide')">
        </div>
      </form>

      <button 
        (click)="generate3DModel()" 
        [disabled]="uploadForm.invalid || status !== StatusEnum.Initial"
      >
        @if (status === StatusEnum.Processing) {
          <span>Processando...</span>
        } @else {
          <span>Gerar Modelo 3D</span>
        }
      </button>
    </div>

    <!-- CARD: CONTROLES -->
    <div class="card">
      <h3>Controles de Visualiza√ß√£o</h3>

      <div class="form-group">
        <label>Rota√ß√£o X: {{ rotationX }}¬∞</label>
        <input type="range" min="0" max="360" [(ngModel)]="rotationX">
      </div>

      <div class="form-group">
        <label>Rota√ß√£o Y: {{ rotationY }}¬∞</label>
        <input type="range" min="0" max="360" [(ngModel)]="rotationY">
      </div>

      <div class="form-group">
        <label>Zoom: {{ zoomValue$ | async }}</label>
        <input type="range" min="10" max="100" formControlName="zoom">
      </div>
    </div>

  </div>

  <!-- MAIN PANEL -->
  <div class="main-panel">

    <div class="viewers">

      <!-- VIEWER: REFER√äNCIA -->
      <div class="card viewer-card reference">
        <h3>Modelo de Refer√™ncia</h3>
        <div class="viewer-content" style="padding: 0; height: 300px;">
          @if (referenceModelUrl) {
            <app-viewer3d 
              [modelUrl]="referenceModelUrl"
              [rotationX]="rotationX"
              [rotationY]="rotationY"
              [zoom]="uploadForm.get('zoom')?.value"
              > </app-viewer3d>
          } @else {
             <div class="placeholder">Sem modelo de refer√™ncia cadastrado</div>
          }
        </div>
      </div>

      <!-- VIEWER: MODELO GERADO -->
      <div class="card viewer-card generated">
        <h3>Modelo Gerado</h3>
        <div class="viewer-content" style="padding: 0; height: 300px;">
          
          @if(status === StatusEnum.Processing || status === StatusEnum.Initial) {
            <div class="placeholder-text">
               {{ status === StatusEnum.Processing ? 'Gerando geometria...' : 'Aguardando in√≠cio' }}
            </div>
          } @else if (generatedModelUrl) {
             <app-viewer3d 
              [modelUrl]="generatedModelUrl"
              [rotationX]="rotationX"
              [rotationY]="rotationY"
              [zoom]="uploadForm.get('zoom')?.value"
              > </app-viewer3d>
          } @else {
             <div class="placeholder">Erro ao carregar modelo</div>
          }

        </div>

    </div>

    <!-- ACTIONS + FEEDBACK -->
    <div class="actions-feedback">

      <div class="actions-buttons">
        <button 
          class="approve" 
          (click)="approvePart()" 
          [disabled]="status !== StatusEnum.Ready"
        >‚úì Aprovar Pe√ßa</button>

        <button 
          class="reject" 
          (click)="rejectPart()" 
          [disabled]="status !== StatusEnum.Ready"
        >‚úó Reprovar Pe√ßa</button>

        <button class="reset" (click)="reboot()">‚Üª Reiniciar</button>
      </div>

      @if (status === StatusEnum.Approved) {
        <div class="feedback-banner approved">‚úì Pe√ßa Aprovada</div>
      }

      @if (status === StatusEnum.Rejected) {
        <div class="feedback-banner rejected">
          ‚úó Pe√ßa Reprovada: A pe√ßa n√£o atende aos padr√µes de qualidade.
        </div>
      }

    </div>

    <!-- üîΩ AQUI: AN√ÅLISE DE DEFEITOS ABAIXO DOS BOT√ïES -->
    <div class="card viewer-card ai-analysis mt-3" *ngIf="showAnalysis">
      <h3>An√°lise de Defeitos (IA)</h3>

      <div class="canvas-container" style="display: flex; gap: 20px; overflow-x: auto;">
        <div>
          <h4>Vista Frontal</h4>
          <canvas #defectCanvasFront></canvas>
        </div>

        <div>
          <h4>Vista Lateral</h4>
          <canvas #defectCanvasSide></canvas>
        </div>
      </div>

      <div class="analysis-summary mt-3">
        <p><strong>Status:</strong> An√°lise Conclu√≠da</p>
        <p><strong>Total de Defeitos:</strong> {{ totalDefects }}</p>
      </div>
    </div>

  </div>
</div>
